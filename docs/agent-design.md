# エージェント設計（フロー・役割・プロンプト方針）

企業別AI活用レポートを「瞬時に」出すためのエージェントの組み方と、各ステップの役割・プロンプト方針を定義する。

---

## 1. 全体フロー

```
[入力] 企業名 + 公式情報(URL/テキスト) + オプション(業種, 注目領域, ディープサーチ, 補足)
    ↓
(1) 入力収集・正規化
    ↓
(2) 企業プロファイル作成（構造化）
    ↓
(3) 活用案・効果の生成（LLM）
    ↓
(4) スプレッドシート用データ整形 → CSV / Google Sheets 出力
```

---

## 2. 各エージェントの役割

### Agent 1: 入力収集・正規化

- **入力**: ユーザーが渡した企業名・URL・テキスト・オプション項目。
- **やること**:
  - 必須チェック: 企業名と「公式情報（URL or テキスト）」が揃っているか。
  - URL のみの場合は、**HP取得**を実行（実装では `fetch` + 簡易パース、または MCP/ブラウザでテキスト抽出）。要約が既にある場合はスキップ。
  - オプション（業種・注目領域・ディープサーチ結果・補足）をキー名で正規化し、次のステップ用の JSON にまとめる。
- **出力**: `CompanyInput` 型のオブジェクト（後述）。
- **プロンプト**: ほぼ不要（ルールベース）。URL からテキストを取る部分だけスクレイピング or 既存ツールに委譲。

### Agent 2: 企業プロファイル作成（構造化）

- **入力**: Agent 1 の出力（企業名 + 公式情報テキスト + オプション）。
- **やること**:
  - 公式情報＋オプションから「業種」「事業概要（1〜2文）」「強み・課題のキーワード」「注目領域」を抽出。
  - ディープサーチ結果がある場合は要約し、「業界トレンド・他社事例のメモ」として1ブロックにまとめる。
  - 出力は **構造化されたプロファイル**（JSON）。ここまででLLMに渡すコンテキストの「種」が揃う。
- **出力**: `CompanyProfile` 型（業種, 事業概要, キーワード, 注目領域, ディープサーチ要約 など）。
- **プロンプト方針**:
  - 「以下の企業の公式情報（とオプション）から、業種・事業概要・キーワードを抽出し、指定のJSONスキーマで返す。推測は最小限にし、書かれている事実を優先する。」
  - 出力形式を JSON に固定し、パース失敗時はリトライ or 手動確認。

### Agent 3: 活用案・効果の生成（LLM）

- **入力**: `CompanyProfile` + 出力仕様（output-spec.md の「活用案・効果一覧」の列定義）。
- **やること**:
  - プロファイルとディープサーチ要約を踏まえ、「活用シーン」「活用方法」「期待効果（定性・定量）」「優先度」「備考」を **複数案** 生成（例: 3〜8案）。
  - 各案はその企業の事業・業種に紐づいた具体案にし、汎用フレーズの羅列にしない（output-spec のクオリティ基準をプロンプトに含める）。
- **出力**: 活用案の配列（1案1オブジェクト）。列名は output-spec のシート2と一致させる。
- **プロンプト方針**:
  - システム: 「あなたはAI活用コンサルタント。企業の公式情報とプロファイルに基づき、具体的なAI活用案と期待効果を、指定のJSON形式で出力する。」
  - ユーザー: プロファイル全文 + 「注目領域があればそれを優先して案を出し、出力は必ず指定スキーマのJSONのみ。」
  - 禁止事項: 他社機密・投資助言・医療診断に見える表現。数値は根拠が不明なら「想定」「目安」と付ける。

### Agent 4: スプレッドシート用整形・出力

- **入力**: 企業サマリ（1行） + 活用案の配列。
- **やること**:
  - output-spec に従い、サマリ用の1行と、活用案の行リストを組み立てる。
  - CSV の場合は BOM付きUTF-8でエスケープして書き出し。Google Sheets の場合は API でスプレッドシート作成 or 既存シートに追記（実装で選択）。
- **出力**: ファイル（`data/out/{企業ID}_summary.csv`, `{企業ID}_utilization.csv`）または Google Sheets の URL。
- **プロンプト**: 不要（ルールベース + ライブラリ）。

---

## 3. データ型（実装用のイメージ）

```ts
// Agent 1 出力
interface CompanyInput {
  companyName: string;
  officialInfo: { type: "url" | "text"; value: string };
  industry?: string;
  businessSummary?: string;
  focusAreas?: string[];
  existingAiDx?: string;
  deepSearchResult?: string;
  memo?: string;
}

// Agent 2 出力
interface CompanyProfile {
  companyName: string;
  industry: string;
  businessSummary: string;
  keywords: string[];
  focusAreas: string[];
  deepSearchSummary?: string;
}

// Agent 3 出力（1案）
interface UtilizationRow {
  companyName: string;
  no: number;
  scene: string;           // 活用シーン
  method: string;           // 活用方法
  effectQualitative: string; // 期待効果（定性的）
  effectQuantitative?: string; // 期待効果（定量的）
  priority: "高" | "中" | "低";
  note?: string;
}
```

---

## 4. エージェントの組み方（実装パターン）

- **パターンA（一括スクリプト）**: Node/TS の1本のスクリプトで、Agent 1 → 2 → 3 → 4 を順に実行。入力は JSON ファイル、出力は CSV。LLM は OpenAI / Anthropic / 自社API のいずれかを呼ぶ。
- **パターンB（Cursor + スキル）**: Agent 2・3 を Cursor のスキルとして定義し、入力収集と出力は手動 or 小さなスクリプト。スプレッドシートは手動でCSVをインポート。
- **パターンC（ワークフローエンジン）**: n8n / LangChain / 自社オーケストレーターで各ステップをノード化し、URL取得・LLM・Sheet API を繋ぐ。

まずは **パターンA** で「1企業入力 → CSV まで出る」を実装し、クオリティが安定したら B/C に展開するのがおすすめ。

---

## 5. ディープサーチの組み込み

- ディープサーチは **入力のオプション** として受け取り、Agent 2 で要約してプロファイルに載せる。
- ディープサーチ自体の実行は、**このパイプラインの外** で行う想定（例: 別スクリプトで Perplexity API や x-research の Grok を叩き、結果をファイルに保存 → そのファイルパス or テキストを `deepSearchResult` に渡す）。
- 同一の入力仕様・出力仕様にしておけば、ディープサーチあり/なしの両方で同じパイプラインが使える。
